## PartiQL ISL Kotlin

PartiQL ISL Kotlin provides an in-memory [Ion Schema Language](https://amzn.github.io/ion-schema/docs/spec.html) (ISL) object
model. The open-source Kotlin implementation of ISL, [ion-schema-kotlin](https://github.com/amzn/ion-schema-kotlin) allows
for validation of schemas, but does not provide ways for programmatic manipulation of ISL schemas. The implementation 
uses [partiql-ir-generator](https://github.com/partiql/partiql-ir-generator) (PIG), a domain modeling and code generating 
tool for tree-like data structures, to generate class definitions and APIs for creating/manipulating 
ISL entities. PIG also provides visitors, tree walkers, visitor transforms, as well as (de)serialization code to and from Ion.
Some possible use cases for this API could include rewriting schemas through visitor transforms, unifying/merging 
multiple schemas, and inferring schemas.

## Using PIG ISL Domain and Parser

### PIG ISL Domain
PartiQL ISL Kotlin uses PIG's DSL to model ISL in `isl.ion`. PIG uses that file to generate `isl-model.kt` in which 
users can create and manipulate the `IonSchemaModel` class. Users can create instances of `IonSchemaModel` using the following pattern:

```Kotlin
// Defining an ISL type_definition
IonSchemaModel.build {
    typeDefinition("foo", constraintList())
}
```

### Converting an ISL document to `IonSchemaModel`
`parseSchema` is the primary API to convert from ISL to the object domain model, `IonSchemaModel`
```Kotlin
/**
 * Transforms an ISL document into an [IonSchemaModel.Schema], which is a PIG-generated in-memory object representing
 * ISL entities.
 *
 * @param elements an [IonElement] representation of an ISL document to be transformed to [IonSchemaModel.Schema]
 * @return [elements] transformed into an [IonSchemaModel.Schema]
 */
fun parseSchema(elements: List<AnyElement>): IonSchemaModel.Schema
```

Users can load schemas that can be converted to `IonElement`. [ion-element-kotlin](https://github.com/amzn/ion-element-kotlin/blob/master/src/com/amazon/ionelement/api/IonElementLoader.kt)
provides several functions to create `IonElement` instances from different sources. The following is an example using `loadAllElements(ionText: String)`:
```Kotlin
val elements: List<AnyElement> = loadAllElements("type::{ name: foo }")
val parsedSchemaModel: IonSchemaModel.Model = parseSchema(elements)
```

Alternatively, users can parse `ion-schema-kotlin` [Schema](https://github.com/amzn/ion-schema-kotlin/blob/master/src/com/amazon/ionschema/Schema.kt#L36)
by first converting to `IonElement`:
```Kotlin
val schema = ... // some ion-schema-kotlin Schema object
val schemaElements = schema.isl.map { it.toIonElement() }
val parsedSchemaModel: IonSchemaModel.Model = parseSchema(schemaElements)
```

### Converting an `IonSchemaModel` to an ISL document
`toIsl` is the primary API to convert from an `IonSchemaModel` to ISL:
```Kotlin
/**
 * Transforms a PIG-generated [IonSchemaModel.Schema] into an [IonElement] representation of an ISL document.
 *
 * @receiver [IonSchemaModel.Schema] to be transformed to an ISL document
 * @return transformed ISL document represented as a List<[AnyElement]>
 */
fun IonSchemaModel.Schema.toIsl(): List<AnyElement>
```

We can convert an `IonSchemaModel.Schema` back to an `IonElement` representation of ISL using the `toIsl` extension function:
```Kotlin
val schemaModel = IonSchemaModel.build {
    schema(typeStatement(typeDefinition("foo", constraintList())))
}
val islElements: List<AnyElement> = schemaModel.toIsl()
```

## API Status
PartiQL ISL Kotlin is currently usable, but the `isl.ion` domain definition and the code generated by PIG is under development and subject to change.

## Building
Clone the repo and from the root directory run the following:

```
$./gradlew build
```

This will use PIG to generate the object model file, which can be found at `src/org/partiql/ionschema/model/isl-model.kt`.
The command will also run the ISL parser's unit tests.

## Security

See [CONTRIBUTING](CONTRIBUTING.md#security-issue-notifications) for more information.

## License

This project is licensed under the Apache-2.0 License.

