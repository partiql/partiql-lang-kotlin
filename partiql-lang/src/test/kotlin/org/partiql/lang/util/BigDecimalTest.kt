/*
 * Copyright 2019 Amazon.com, Inc. or its affiliates.  All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License").
 *  You may not use this file except in compliance with the License.
 * A copy of the License is located at:
 *
 *      http://aws.amazon.com/apache2.0/
 *
 *  or in the "license" file accompanying this file. This file is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific
 *  language governing permissions and limitations under the License.
 */

package org.partiql.lang.util

import junitparams.Parameters
import org.junit.Test
import org.partiql.lang.TestBase
import java.math.MathContext
import java.math.RoundingMode

/**
 * Testing for implemented big decimal operations.
 */
class BigDecimalTest : TestBase() {
    companion object {
        // In the future, if we decided to change the MathContext setting in NumberExtensions.kt configurable,
        // we need to adjust this setting as well.
        private val MATH_CONTEXT = MathContext(38, RoundingMode.HALF_EVEN)

        // the following result are generate.
        private val SQRT_TEST = mapOf(
            "0.21110138" to "0.45945770207931001665275155324149977065",
            "478.46717" to "21.873892429103696220819273717517919326",
            "415584.1345" to "644.65815320990085186740951090192433294",
            "21110138.0" to "4594.5770207931001665275155324149977065",
            "0.10138" to "0.31840226129850271526635944488253922921",
            "0.1179272160" to "0.34340532319694754551200079143327428404",
            "1179.272160" to "34.340532319694754551200079143327428404",
            "10138.211" to "100.68868357466989944517650842483817439",
            "0.1345415584" to "0.36679907088213841330327230624492195282",
            "272160.1179" to "521.68967586104289322824448847021360124",
            "211.0" to "14.525839046333950068328757845437275471",
            "1345.0" to "36.674241641784496482322020991959908091",
            "1179.0" to "34.336569426778791117130302864576552396",
            "0.47846717" to "0.69171321369480863777951351412668243034",
            "0.211" to "0.45934736311423406275976659836120329052",
            "1345.415584" to "36.679907088213841330327230624492195282",
            "415584.0" to "644.65804889103804627135532177279670955",
            "47846717.0" to "6917.1321369480863777951351412668243034",
            "47846717.47846717" to "6917.1321715337469760714157507121761446",
            "478.0" to "21.863211109075446147927380100539533236",
            "0.478" to "0.69137544069774419490020721482604418817",
            "1179272160.1179272160" to "34340.532321411781167141891205489960201",
            "10138.0" to "100.68763578513500880005284639241421975",
            "0.415584" to "0.64465804889103804627135532177279670955",
            "0.1345" to "0.36674241641784496482322020991959908091",
            "272160.0" to "521.68956286281978865387190965811178203",
            "21110138.21110138" to "4594.5770437659852130608038922998852918",
            "211.10138" to "14.529328270777007948330850764383984902",
            "0.1179" to "0.34336569426778791117130302864576552396",
            "46717.478" to "216.14226333597971278555002590247542762",
            "0.46717" to "0.68349835405800356616267402621456224951",
            "0.272160" to "0.52168956286281978865387190965811178203",
            "1345415584.1345415584" to "36679.907090047836684692072807150582006",
            "1179272160.0" to "34340.532319694754551200079143327428404",
            "46717.0" to "216.14115757994820177551858681255782273",
            "1345415584.0" to "36679.907088213841330327230624492195282"
        )

        private val EXPR_TEST = mapOf(
            "211.10138" to "4.7881137156135624143678214058639175770E+91",
            "21110138.21110138" to "3.4458495618078853317672847618778902265E+9168016",
            "0.1179" to "1.1251315925822385940597301973825993928",
            "46717.0" to "8.6161068127580746298831702942179612282E+20288",
            "47846717.0" to "1.4800845034858872116595597116784606738E+20779565",
            "0.415584" to "1.5152553914975046594425606182856892710",
            "1345.415584" to "2.0256480852957812140885796494019963950E+584",
            "478.0" to "3.9152757070996188069360268955227069985E+207",
            "415584.0" to "6.8860041642986589078852297653300103883E+180485",
            "0.1179272160" to "1.1251622145803645725935953788106531371",
            "478.46717" to "6.2467151540460696094357327895723938070E+207",
            "1179.272160" to "1.4170714559254893441870779832781779562E+512",
            "0.47846717" to "1.6135991324355023196311912746084738093",
            "415584.1345" to "7.8773454057009896210253199527751301559E+180485",
            "272160.1179" to "4.3390845070397139187404570339608623972E+118197",
            "0.1345" to "1.1439646590023953382710102706279309153",
            "1345.0" to "1.3368360849677379784396880830018889317E+584",
            "0.272160" to "1.3127970320333277411949274495592740316",
            "1179.0" to "1.0794292044754671619504950183666227876E+512",
            "0.211" to "1.2349123550613943962817356243145023414",
            "211.0" to "4.3264897742306309199371472477969207059E+91",
            "0.21110138" to "1.2350375568223205474814607966834302750",
            "10138.0" to "7.5414965232541353639634759902123037133E+4402",
            "0.478" to "1.6128454833836230636996852521731217528",
            "0.1345415584" to "1.1440122013311647388504779007511104029",
            "0.10138" to "1.1066971067705853873911275834318109298",
            "272160.0" to "3.8565129053760524633291951235115454837E+118197",
            "10138.211" to "9.3130872322190821919069140954764633546E+4402",
            "47846717.47846717" to "2.3882630707560588135020497190002237453E+20779565",
            "21110138.0" to "2.7900767412076559544089808279730912886E+9168016",
            "46717.478" to "1.3896448957307724731257950962282778681E+20289",
            "0.46717" to "1.5954726107075479401118810593888514014",
            "-0.1179" to "0.88878492666350720856655063390581285171",
            "-0.1179272160" to "0.88876073782210638141453331010308599503",
            "-0.46717" to "0.62677352985491094079923138162615312118",
            "-0.272160" to "0.76173237415927763963304112127031379867",
            "-46717.478" to "7.1960829926564085529476244576397528829E-20290",
            "-0.478" to "0.62002219698199395659773673140777104793",
            "-415584.0" to "1.4522210212776573708411196122290304338E-180486",
            "-1345.0" to "7.4803486474120207260424577024801612619E-585",
            "-415584.1345" to "1.2694631865149398615178912860816030677E-180486",
            "-46717.0" to "1.1606169952759594109904193541121277520E-20289",
            "-0.21110138" to "0.80969197614762546612221299126472479825",
            "-10138.0" to "1.3259967659157690669506927986801256378E-4403",
            "-0.47846717" to "0.61973260886093796640067339340511771477",
            "-10138.211" to "1.0737577938070320427291390274116555480E-4403",
            "-211.0" to "2.3113425714217192407174559117378441093E-92",
            "-0.1345415584" to "0.87411655123643512660832677232556268064",
            "-478.0" to "2.5540985483772889636284345328301324811E-208",
            "-478.46717" to "1.6008413627637374200733258510635520152E-208",
            "-272160.1179" to "2.3046336119464920962897095803974148550E-118198",
            "-211.10138" to "2.0885051178694848013776647490757576345E-92",
            "-1179.272160" to "7.0568071625357806442372277851626017508E-513",
            "-0.211" to "0.80977406688127629109291584997766120955",
            "-272160.0" to "2.5930160861279135051563816153221654383E-118198",
            "-1345.415584" to "4.9366916556682249910677313008453760123E-585",
            "-0.415584" to "0.65995475456564103033263656731434957116",
            "-0.1345" to "0.87415287887657210235068384333626061621",
            "-1179.0" to "9.2641554986085018663331833630380657702E-513",
            "-0.10138" to "0.90358960358906645164365670738959758038"
        )

        private val LN_TEST = mapOf(
            "211.10138" to "5.3523384920190753103816105403348109938",
            "1179272160.0" to "20.888163271556918744184350491293996405",
            "21110138.21110138" to "16.865263966989303680471568147089962865",
            "1345415584.0" to "21.019968786660985872889840379385965894",
            "0.1179" to "-2.1379184714388118091320513337228795280",
            "46717.0" to "10.751863403111641705306298030487351901",
            "47846717.0" to "17.683513063269112792320609873570800477",
            "0.415584" to "-0.87807051905445730241446929745095952258",
            "1345.415584" to "7.2044582286967117687818916512797806479",
            "478.0" to "6.1696107324914559763803957157200856645",
            "415584.0" to "12.937440038909816801693479430655225723",
            "0.1179272160" to "-2.1376876583835380959955640555496456709",
            "478.46717" to "6.1705875982988843722306526001489794388",
            "1179.272160" to "7.0726527135926446400764017631878111595",
            "0.47846717" to "-0.73716768068325267982332176390411318397",
            "1179272160.1179272160" to "20.888163271656918744179350491294329738",
            "415584.1345" to "12.937440362550713070921601527953890901",
            "1345415584.1345415584" to "21.019968786760985872884840379386299227",
            "272160.1179" to "12.514145840830653053275385285703002722",
            "0.1345" to "-2.0061910799402432552512533050160320730",
            "1345.0" to "7.2041492920359394808207125137214247574",
            "0.272160" to "-1.3013651503345854203394498595333065128",
            "1179.0" to "7.0724219005373709269399144850145773024",
            "0.211" to "-1.5558971455060705563120180985988125048",
            "211.0" to "5.3518581334760664957419562654542801180",
            "0.21110138" to "-1.5554167869630617416723638237182816290",
            "10138.0" to "9.2240460190322946691005179204694891225",
            "0.478" to "-0.73814454649068107567357864833300695829",
            "0.1345415584" to "-2.0058821432794709672900741674576761825",
            "0.10138" to "-2.2888794459379337509894393529523319155",
            "272160.0" to "12.514145407629688683768498868572878733",
            "10138.211" to "9.2240668315992982001299054514619735497",
            "47846717.47846717" to "17.683513073269112742320610206904131310",
            "21110138.0" to "16.865263956989303730471567813756632032",
            "46717.478" to "10.751873634880689618649715671483901931",
            "0.46717" to "-0.76106206185858671478365924293446913717"
        )

        private val POW_TEST = mapOf(
            ("415584.1345" to "0.415584") to "216.28418529996542587717066110292223036",
            ("415584.1345" to "0.1345") to "5.6978318698130923211000253171551208901",
            ("415584.1345" to "1345.0") to "1.2482466351060784656907492261943307812E+7557",
            ("415584.1345" to "1345.415584") to "2.6997600652734140299731423160659197543E+7559",
            ("415584.1345" to "0.1345415584") to "5.7008961859358412825774378255391912452",
            ("415584.1345" to "-1345.415584") to "3.7040328615229240559116378885934381276E-7560",
            ("415584.1345" to "-0.415584") to "0.0046235465557183290509707210308332773211",
            ("415584.1345" to "-0.1345") to "0.17550535411512647851649866428634630830",
            ("415584.1345" to "-0.1345415584") to "0.17541101738828508916429847843627939983",
            ("415584.1345" to "-1345.0") to "8.0112372977878528301950204831282286771E-7558",
            ("1345415584.1345415584" to "0.415584") to "6220.2333946027583337486695380314345113",
            ("1345415584.1345415584" to "0.1345") to "16.897839978196542095213950865256070483",
            ("1345415584.1345415584" to "1345.0") to "2.0508337394355479128244839354958185071E+12278",
            ("1345415584.1345415584" to "1345.415584") to "1.2756664512815046965615579805545838477E+12282",
            ("1345415584.1345415584" to "0.1345415584") to "16.912607641526291747718021621736045707",
            ("1345415584.1345415584" to "-1345.415584") to "7.8390397348415283346739355732946828258E-12283",
            ("1345415584.1345415584" to "-0.415584") to "0.00016076567172988897522132214285771353629",
            ("1345415584.1345415584" to "-0.1345") to "0.059179161436628016079218222029111555448",
            ("1345415584.1345415584" to "-0.1345415584") to "0.059127487682304808880861567582129642414",
            ("1345415584.1345415584" to "-1345.0") to "4.8760656740279226374098714049486314125E-12279",
            ("1345415584.0" to "0.415584") to "6220.2333943442553862607068979148355944",
            ("1345415584.0" to "0.1345") to "16.897839977969266147520099602208190587",
            ("1345415584.0" to "1345.0") to "2.0508334635984285225818404539068378808E+12278",
            ("1345415584.0" to "1345.415584") to "1.2756662796513638968253107479840936158E+12282",
            ("1345415584.0" to "0.1345415584") to "16.912607641298746888861059992043429556",
            ("1345415584.0" to "-1345.415584") to "7.8390407895182215159634635547937918182E-12283",
            ("1345415584.0" to "-0.415584") to "0.00016076567173657013931314633188586156022",
            ("1345415584.0" to "-0.1345") to "0.059179161437423975800506423688438944908",
            ("1345415584.0" to "-0.1345415584") to "0.059127487683100319314532552830184749310",
            ("1345415584.0" to "-1345.0") to "4.8760663298587998659994272196304959156E-12279",
            ("415584.0" to "0.415584") to "216.28415620974916674124738270383680151",
            ("415584.0" to "0.1345") to "5.6978316217881826523069762685810242435",
            ("415584.0" to "1345.0") to "1.2477033953276159929044750375306533337E+7557",
            ("415584.0" to "1345.415584") to "2.6985847605847251602763899957264719124E+7559",
            ("415584.0" to "0.1345415584") to "5.7008959377008658155245790446579538805",
            ("415584.0" to "-1345.415584") to "3.7056460653224824076034348917239857038E-7560",
            ("415584.0" to "-0.415584") to "0.0046235471775852819848377657659428921608",
            ("415584.0" to "-0.1345") to "0.17550536175482215403254874803518086053",
            ("415584.0" to "-0.1345415584") to "0.17541102502623359302567575502702030610",
            ("415584.0" to "-1345.0") to "8.0147253245025014979272955144902730469E-7558",
            ("0.415584" to "415584.1345") to "4.5215121482252360180898591547166504649E-158480",
            ("0.415584" to "415584.0") to "5.0883161920784949360214191113261029552E-158480",
            ("0.415584" to "0.415584") to "0.69425770219419927909697090194030776950",
            ("0.415584" to "0.1345") to "0.88860675664463205740553122049011145939",
            ("0.415584" to "1345.0") to "1.2477033953276159929044750375306533337E-513",
            ("0.415584" to "1345.415584") to "8.6622769226005131627177506328221661585E-514",
            ("0.415584" to "0.1345415584") to "0.88857433090417835838008029662545885928",
            ("0.415584" to "-415584.0") to "1.9652866729406533996195053645682053083E+158479",
            ("0.415584" to "-415584.1345") to "2.2116494818940508301135020947339768035E+158479",
            ("0.415584" to "-1345.415584") to "1.1544308833984826350107455488409161785E+513",
            ("0.415584" to "-0.415584") to "1.4403873328873459416556372191221566284",
            ("0.415584" to "-0.1345") to "1.1253571869923512951920652151618324919",
            ("0.415584" to "-0.1345415584") to "1.1253982533824033097297430675804446550",
            ("0.415584" to "-1345.0") to "8.0147253245025014979272955144902730469E+512",
            ("0.1345" to "415584.1345") to "6.3771649136712769326310861498957092344E-362090",
            ("0.1345" to "415584.0") to "8.3524618517135432420457121759901496032E-362090",
            ("0.1345" to "0.415584") to "0.43442111087448476767409914040221892663",
            ("0.1345" to "0.1345") to "0.76350721821770120369972397912740717253",
            ("0.1345" to "1345.0") to "1.3535441780434894021125678954731654072E-1172",
            ("0.1345" to "1345.415584") to "5.8800816544334406041196840269073891027E-1173",
            ("0.1345" to "0.1345415584") to "0.76344356415070970791021891999057538593",
            ("0.1345" to "-415584.0") to "1.1972518016288164508398069478335232912E+362089",
            ("0.1345" to "-415584.1345") to "1.5680949348764903176092235997575506996E+362089",
            ("0.1345" to "-1345.415584") to "1.7006566554157015371059772391667630460E+1172",
            ("0.1345" to "-0.415584") to "2.3019139147888355264782347229564832237",
            ("0.1345" to "-0.1345") to "1.3097453123421118318269144445144666470",
            ("0.1345" to "-0.1345415584") to "1.3098545157197660369967999413410963398",
            ("0.1345" to "-1345.0") to "7.3880115346177491338289505622626008102E+1171",
            ("1345.0" to "0.415584") to "19.963970608503789119461756033043020716",
            ("1345.0" to "0.1345") to "2.6351973630557497836163992267398527924",
            ("1345.0" to "1345.0") to "1.3535441780434894021125678954731654072E+4208",
            ("1345.0" to "1345.415584") to "2.7022116187771642199143914432408655569E+4209",
            ("1345.0" to "0.1345415584") to "2.6359864405998380014175148188813319280",
            ("1345.0" to "-1345.415584") to "3.7006724160727702890825552063126058310E-4210",
            ("1345.0" to "-0.415584") to "0.050090236036214318799085464349364900142",
            ("1345.0" to "-0.1345") to "0.37947821822362842560528776209245618001",
            ("1345.0" to "-0.1345415584") to "0.37936462213836072815610349038967585217",
            ("1345.0" to "-1345.0") to "7.3880115346177491338289505622626008102E-4209",
            ("1345.415584" to "0.415584") to "19.966533929933839110473599621155570161",
            ("1345.415584" to "0.1345") to "2.6353068630011324191837166339385028007",
            ("1345.415584" to "1345.0") to "2.0508334635984285225818404539068378808E+4208",
            ("1345.415584" to "1345.415584") to "4.0948035935581758024587907942535461480E+4209",
            ("1345.415584" to "0.1345415584") to "2.6360960071782447941521049748232748019",
            ("1345.415584" to "-1345.415584") to "2.4421195721650007715294299439785684151E-4210",
            ("1345.415584" to "-0.415584") to "0.050083805407046609472122703306239366784",
            ("1345.415584" to "-0.1345") to "0.37946245047955551483780916640647140300",
            ("1345.415584" to "-0.1345415584") to "0.37934885424390502540731562781305823034",
            ("1345.415584" to "-1345.0") to "4.8760663298587998659994272196304959156E-4209",
            ("0.1345415584" to "415584.1345") to "3.6587926004559833965480895911880356912E-362034",
            ("0.1345415584" to "415584.0") to "4.7918873407312828886987134834890659904E-362034",
            ("0.1345415584" to "0.415584") to "0.43447688940496889697528414194838332260",
            ("0.1345415584" to "0.1345") to "0.76353894411416200612561138430834968096",
            ("0.1345415584" to "1345.0") to "2.0508334635984285225818404539068378808E-1172",
            ("0.1345415584" to "1345.415584") to "8.9103974395186373541368142925729420144E-1173",
            ("0.1345415584" to "0.1345415584") to "0.76347529720435608605420326701066611502",
            ("0.1345415584" to "-415584.0") to "2.0868604140584646316197268264410084409E+362033",
            ("0.1345415584" to "-415584.1345") to "2.7331420749986573694812924883139481014E+362033",
            ("0.1345415584" to "-1345.415584") to "1.1222843950426778926943923354085158065E+1172",
            ("0.1345415584" to "-0.415584") to "2.3016183930278421279100273539778764559",
            ("0.1345415584" to "-0.1345") to "1.3096908909606096797644121818958314432",
            ("0.1345415584" to "-0.1345415584") to "1.3098000729843317819507815386835929801",
            ("0.1345415584" to "-1345.0") to "4.8760663298587998659994272196304959156E+1171",
            ("-415584.0" to "1345.0") to "-1.2477033953276159929044750375306533337E+7557",
            ("-415584.0" to "-1345.0") to "-8.0147253245025014979272955144902730469E-7558",
            ("-1345415584.0" to "1345.0") to "-2.0508334635984285225818404539068378808E+12278",
            ("-1345415584.0" to "-1345.0") to "-4.8760663298587998659994272196304959156E-12279",
            ("-1345415584.1345415584" to "1345.0") to "-2.0508337394355479128244839354958185071E+12278",
            ("-1345415584.1345415584" to "-1345.0") to "-4.8760656740279226374098714049486314125E-12279",
            ("-415584.1345" to "1345.0") to "-1.2482466351060784656907492261943307812E+7557",
            ("-415584.1345" to "-1345.0") to "-8.0112372977878528301950204831282286771E-7558",
            ("-1345.415584" to "1345.0") to "-2.0508334635984285225818404539068378808E+4208",
            ("-1345.415584" to "-1345.0") to "-4.8760663298587998659994272196304959156E-4209",
            ("-0.415584" to "415584.0") to "5.0883161920784949360214191113261029552E-158480",
            ("-0.415584" to "1345.0") to "-1.2477033953276159929044750375306533337E-513",
            ("-0.415584" to "-415584.0") to "1.9652866729406533996195053645682053083E+158479",
            ("-0.415584" to "-1345.0") to "-8.0147253245025014979272955144902730469E+512",
            ("-0.1345" to "415584.0") to "8.3524618517135432420457121759901496032E-362090",
            ("-0.1345" to "1345.0") to "-1.3535441780434894021125678954731654072E-1172",
            ("-0.1345" to "-415584.0") to "1.1972518016288164508398069478335232912E+362089",
            ("-0.1345" to "-1345.0") to "-7.3880115346177491338289505622626008102E+1171",
            ("-0.1345415584" to "415584.0") to "4.7918873407312828886987134834890659904E-362034",
            ("-0.1345415584" to "1345.0") to "-2.0508334635984285225818404539068378808E-1172",
            ("-0.1345415584" to "-415584.0") to "2.0868604140584646316197268264410084409E+362033",
            ("-0.1345415584" to "-1345.0") to "-4.8760663298587998659994272196304959156E+1171",
            ("-1345.0" to "1345.0") to "-1.3535441780434894021125678954731654072E+4208",
            ("-1345.0" to "-1345.0") to "-7.3880115346177491338289505622626008102E-4209"
        )
    }

    @Test
    @Parameters
    fun sqrt(pair: Pair<String, String>) = assertPair(pair)

    fun parametersForSqrt(): List<Pair<String, String>> {
        val transform: (Pair<String, String>) -> Pair<String, String> =
            { (number, result) -> "${bigDecimalOf(number,MATH_CONTEXT).squareRoot(MATH_CONTEXT)}" to result }

        val parameters = SQRT_TEST.map {
            transform(it.toPair())
        }

        return parameters
    }

    @Test
    @Parameters
    fun exp(pair: Pair<String, String>) = assertPair(pair)

    fun parametersForExp(): List<Pair<String, String>> {
        val transform: (Pair<String, String>) -> Pair<String, String> =
            { (number, result) -> "${bigDecimalOf(number,MATH_CONTEXT).exp(MATH_CONTEXT)}" to result }

        val parameters = EXPR_TEST.map {
            transform(it.toPair())
        }

        return parameters
    }

    @Test
    @Parameters
    fun ln(pair: Pair<String, String>) = assertPair(pair)

    fun parametersForLn(): List<Pair<String, String>> {
        val transform: (Pair<String, String>) -> Pair<String, String> =
            { (number, result) -> "${bigDecimalOf(number,MATH_CONTEXT).ln(MATH_CONTEXT)}" to result }

        val parameters = LN_TEST.map {
            transform(it.toPair())
        }

        return parameters
    }

    @Test
    @Parameters
    fun pow(pair: Pair<String, String>) = assertPair(pair)

    fun parametersForPow(): List<Pair<String, String>> {
        val transform: (Pair<Pair<String, String>, String>) -> Pair<String, String> =
            { (pair, result) -> "${bigDecimalOf(pair.first,MATH_CONTEXT).power(bigDecimalOf(pair.second, MATH_CONTEXT), MATH_CONTEXT)}" to result }

        val parameters = POW_TEST.map {
            transform(it.toPair())
        }

        return parameters
    }

    private fun assertPair(pair: Pair<String, String>) {
        assertEquals(bigDecimalOf(pair.second), bigDecimalOf(pair.first))
    }
}
